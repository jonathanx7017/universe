<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zoom Saturn Magic</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family:system-ui; }
        #info { position:absolute; top:20px; left:20px; z-index:100; background:rgba(0,0,0,0.6); padding:12px 25px; border-radius:30px; backdrop-filter:blur(10px); color:#fff; font-size:14px; }
        #menu { position:absolute; bottom:40px; left:50%; transform:translateX(-50%); z-index:100; background:rgba(15,15,25,0.85); padding:16px 32px; border-radius:50px; backdrop-filter:blur(15px); border:1px solid rgba(80,120,180,0.3); box-shadow:0 10px 40px rgba(0,0,0,0.6); display:flex; gap:20px; }
        .btn { padding:12px 28px; background:rgba(40,40,60,0.6); color:#ccc; border:1px solid rgba(100,150,220,0.4); border-radius:30px; cursor:pointer; font-weight:500; font-size:15px; transition:all .4s; min-width:90px; text-align:center; }
        .btn:hover { background:rgba(70,120,200,0.4); color:#fff; transform:translateY(-2px); }
        .btn.active { background:linear-gradient(135deg,rgba(100,180,255,0.6),rgba(60,120,220,0.8)); color:white; border:1px solid rgba(120,200,255,0.8); box-shadow:0 0 20px rgba(100,180,255,0.5); font-weight:600; }
    </style>
</head>
<body>
<div id="info">손 벌리기 = 새턴 확대 (우주처럼 퍼짐) • 오므리기 = 새턴 선명하게 모임</div>

<div id="menu">
    <div class="btn active" data-shape="Saturn">Saturn</div>
    <div class="btn" data-shape="Sphere">Sphere</div>
    <div class="btn" data-shape="Heart">Heart</div>
    <div class="btn" data-shape="Flower">Flower</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>

<script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 35;
    const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(innerWidth, innerHeight); renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0x404040));

    const COUNT = 3000;
    const geom = new THREE.BufferGeometry();
    const pos = new Float32Array(COUNT*3);
    const target = new Float32Array(COUNT*3);
    for(let i=0;i<COUNT*3;i++) pos[i]=(Math.random()-0.5)*50;
    geom.setAttribute('position', new THREE.BufferAttribute(pos,3));

    const canvas = document.createElement('canvas'); canvas.width=canvas.height=32;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createRadialGradient(16,16,0,16,16,16);
    grad.addColorStop(0,'rgba(255,255,255,1)');
    grad.addColorStop(0.4,'rgba(255,255,255,0.4)');
    grad.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=grad; ctx.fillRect(0,0,32,32);
    const tex = new THREE.CanvasTexture(canvas);

    const mat = new THREE.PointsMaterial({
        size:0.6, map:tex, transparent:true, opacity:0.9,
        depthWrite:false, blending:THREE.AdditiveBlending, color:0xffffff
    });
    const particles = new THREE.Points(geom, mat); scene.add(particles);

    // 새턴 형태 고정 (항상 새턴 파티클만 사용)
    const saturnShape = () => {
        const a = [];
        for(let i=0; i<COUNT; i++){
            if(Math.random()>0.3){
                const u=Math.random(),v=Math.random();
                const theta=2*Math.PI*u,phi=Math.acos(2*v-1);
                a.push(6*Math.sin(phi)*Math.cos(theta),6*Math.sin(phi)*Math.sin(theta),6*Math.cos(phi));
            } else {
                const ang=Math.random()*Math.PI*2,d=9+Math.random()*6;
                a.push(d*Math.cos(ang),(Math.random()-0.5)*0.8,d*Math.sin(ang));
            }
        }
        return a;
    };

    // 처음부터 새턴 형태로 설정 (퍼진 상태로 시작)
    const saturnPositions = saturnShape();
    for(let i=0; i<saturnPositions.length; i++) {
        target[i] = saturnPositions[i] * 5;  // 처음엔 5배로 퍼져서 시작 (넓은 우주처럼)
    }

    function transition(name){
        if(name === 'Saturn') {
            for(let i=0; i<saturnPositions.length; i++) target[i] = saturnPositions[i] * 5;  // 다시 퍼진 상태로
        } else {
            // 다른 모양은 기존처럼
            const shapes = { /* Sphere, Heart, Flower 기존 코드 */ };
            const p = shapes[name]();
            for(let i=0;i<p.length;i++) target[i]=p[i];
        }
        document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
        document.querySelector(`.btn[data-shape="${name}"]`).classList.add('active');
    }
    transition('Saturn');

    document.querySelectorAll('.btn').forEach(btn => btn.onclick = () => transition(btn.dataset.shape));

    const video = document.createElement('video'); video.style.display='none'; document.body.appendChild(video);
    let dist=0, detected=false;

    const hands = new Hands({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}`});
    hands.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:0.7,minTrackingConfidence:0.7});
    hands.onResults(r=>{
        detected = r.multiHandLandmarks && r.multiHandLandmarks.length===2;
        if(detected){
            const a=r.multiHandLandmarks[0][8], b=r.multiHandLandmarks[1][8];
            dist = Math.hypot(a.x-b.x, a.y-b.y);
        }
    });
    new Camera(video,{onFrame:async()=>await hands.send({image:video}),width:640,height:480}).start();

    let scale=5, t=0;  // 시작 스케일 5배 (퍼진 상태)
    function animate(){
        requestAnimationFrame(animate); t+=0.01;

        // 파티클 위치는 새턴 고정, 스케일만 손으로 제어
        const p = geom.attributes.position.array;
        for(let i=0;i<COUNT*3;i++) p[i] += (target[i] - p[i])*0.05;
        geom.attributes.position.needsUpdate = true;

        // 손 거리로 스케일 조절 (줄이면 모이고, 벌리면 퍼짐)
        const targetScale = detected ? Math.max(0.8, Math.min(6, (dist-0.05)*12)) : 5;  // 손 없으면 자동으로 퍼진 상태
        scale += (targetScale - scale)*0.08;
        particles.scale.setScalar(scale);

        particles.rotation.y += 0.003;
        particles.rotation.x += 0.0008;
        mat.size = 0.6 + Math.sin(t*5)*0.08;
        renderer.render(scene,camera);
    }
    animate();

    window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>
