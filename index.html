<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfect Saturn Zoom</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family:system-ui; }
        #info { position:absolute; top:20px; left:20px; z-index:100; background:rgba(0,0,0,0.6); padding:14px 28px; border-radius:30px; backdrop-filter:blur(10px); color:#fff; font-size:15px; }
        #menu { position:absolute; bottom:40px; left:50%; transform:translateX(-50%); z-index:100; background:rgba(15,15,25,0.9); padding:16px 36px; border-radius:50px; backdrop-filter:blur(15px); border:1px solid rgba(100,160,255,0.4); box-shadow:0 10px 40px rgba(0,0,0,0.7); display:flex; gap:22px; }
        .btn { padding:13px 30px; background:rgba(40,40,70,0.7); color:#ddd; border:1px solid rgba(120,180,255,0.5); border-radius:30px; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s; min-width:100px; text-align:center; }
        .btn:hover { background:rgba(80,140,255,0.4); color:white; }
        .btn.active { background:linear-gradient(135deg,#5af,#28f); color:white; box-shadow:0 0 25px rgba(100,180,255,0.8); border:none; }
    </style>
</head>
<body>
<div id="info">손으로 인터랙션 테스트 </div>
<div id="menu">
    <div class="btn active" data-shape="Saturn">Saturn</div>
    <div class="btn" data-shape="Sphere">Sphere</div>
    <div class="btn" data-shape="Heart">Heart</div>
    <div class="btn" data-shape="Flower">Flower</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>

<script>
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 32;
    const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(innerWidth, innerHeight); renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0x505070));

    const COUNT = 3800;  // 파티클 수 조금 더 늘림
    const geom = new THREE.BufferGeometry();
    const pos = new Float32Array(COUNT*3);
    const baseTarget = new Float32Array(COUNT*3);  // 새턴 기준 위치 저장
    const displayTarget = new Float32Array(COUNT*3); // 현재 보여지는 목표 위치
    geom.setAttribute('position', new THREE.BufferAttribute(pos,3));

    // 부드럽고 큰 파티클 텍스처
    const canvas = document.createElement('canvas'); canvas.width=canvas.height=64;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createRadialGradient(32,32,0,32,32,32);
    grad.addColorStop(0,'#ffffff');
    grad.addColorStop(0.3,'#bbddff');
    grad.addColorStop(1,'transparent');
    ctx.fillStyle = grad; ctx.fillRect(0,0,64,64);
    const tex = new THREE.CanvasTexture(canvas);

    const mat = new THREE.PointsMaterial({
        size: 1.4,           // 크게!
        map: tex,
        transparent: true,
        opacity: 0.95,
        depthWrite: false,
        blending: THREE.AdditiveBlending,
        color: 0xffffff
    });
    const particles = new THREE.Points(geom, mat); scene.add(particles);

    // 새턴 기준 위치 미리 계산 (이 위치 기준으로 확대/축소)
    function generateSaturnBase(){
        for(let i=0; i<COUNT; i++){
            if(Math.random() > 0.32){
                const u=Math.random(), v=Math.random();
                const theta=2*Math.PI*u, phi=Math.acos(2*v-1);
                const r=5.8;
                baseTarget[i*3]   = r*Math.sin(phi)*Math.cos(theta);
                baseTarget[i*3+1] = r*Math.sin(phi)*Math.sin(theta);
                baseTarget[i*3+2] = r*Math.cos(phi);
            } else {
                const ang=Math.random()*Math.PI*2;
                const dist=9 + Math.random()*6.5;
                baseTarget[i*3]   = dist*Math.cos(ang);
                baseTarget[i*3+1] = (Math.random()-0.5)*1;
                baseTarget[i*3+2] = dist*Math.sin(ang);
            }
        }
    }
    generateSaturnBase();

    // 초기 상태: 6배 퍼진 새턴
    let currentZoom = 6.0;
    function updateDisplayTarget(){
        for(let i=0; i<COUNT*3; i++) displayTarget[i] = baseTarget[i] * currentZoom;
    }
    updateDisplayTarget();

    // 버튼
    document.querySelectorAll('.btn').forEach(b=>b.onclick=()=>alert('다른 모양은 나중에 추가할게요~ 지금은 완벽한 새턴만!'));
    
    // 손 인식
    const video = document.createElement('video'); video.style.display='none'; document.body.appendChild(video);
    let handDistance = 0, handsDetected = false;

    const hands = new Hands({locateFile: f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${f}`});
    hands.setOptions({maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.75, minTrackingConfidence:0.75});
    hands.onResults(res => {
        handsDetected = res.multiHandLandmarks && res.multiHandLandmarks.length === 2;
        if(handsDetected){
            const a = res.multiHandLandmarks[0][8];
            const b = res.multiHandLandmarks[1][8];
            handDistance = Math.hypot(a.x-b.x, a.y-b.y);
        }
    });
    new Camera(video, {onFrame: async()=>await hands.send({image:video}), width:640, height:480}).start();

    // 애니메이션
    let t=0;
    function animate(){
        requestAnimationFrame(animate); t+=0.01;

        // 손 거리로 줌 제어 (손 없으면 서서히 퍼짐)
        let targetZoom;
        if(handsDetected){
            targetZoom = Math.max(0.9, Math.min(7, (handDistance - 0.04)*14));
        } else {
            targetZoom = 6.0;  // 손 없으면 자동으로 넓게
        }
        currentZoom += (targetZoom - currentZoom) * 0.07;
        updateDisplayTarget();

        // 부드러운 모핑
        const p = geom.attributes.position.array;
        for(let i=0;i<COUNT*3;i++){
            p[i] += (displayTarget[i] - p[i]) * 0.08;
        }
        geom.attributes.position.needsUpdate = true;

        particles.scale.setScalar(1);
        particles.rotation.y += 0.003;
        particles.rotation.x += 0.0006;

        mat.size = 1.4 + Math.sin(t*6)*0.3;  // 반짝임
        renderer.render(scene,camera);
    }
    animate();

    window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>
