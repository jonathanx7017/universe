<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universe ↔ Saturn (안정판)</title>
    <style>
        body { margin:0; overflow:hidden; background:#000; font-family:system-ui; }
        #info { position:absolute; top:20px; left:20px; z-index:100; background:rgba(0,0,0,0.6); padding:12px 25px; border-radius:30px; backdrop-filter:blur(10px); color:#fff; font-size:14px; }
        #menu { position:absolute; bottom:40px; left:50%; transform:translateX(-50%); z-index:100; background:rgba(15,15,25,0.85); padding:16px 32px; border-radius:50px; backdrop-filter:blur(15px); border:1px solid rgba(80,120,180,0.3); box-shadow:0 10px 40px rgba(0,0,0,0.6); display:flex; gap:20px; }
        .btn { padding:12px 28px; background:rgba(40,40,60,0.6); color:#ccc; border:1px solid rgba(100,150,220,0.4); border-radius:30px; cursor:pointer; font-weight:500; font-size:15px; transition:all .4s; min-width:90px; text-align:center; }
        .btn:hover { background:rgba(70,120,200,0.4); color:#fff; transform:translateY(-2px); }
        .btn.active { background:linear-gradient(135deg,rgba(100,180,255,0.6),rgba(60,120,220,0.8)); color:white; border:1px solid rgba(120,200,255,0.8); box-shadow:0 0 20px rgba(100,180,255,0.5); font-weight:600; }
        #loader { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:18px; z-index:999; background:rgba(0,0,0,0.7); padding:20px 40px; border-radius:20px; }
    </style>
</head>
<body>
<div id="loader">Loading… (카메라 권한 허용해주세요)</div>
<div id="info">두 손으로 인터랙션 . 카메라 기반 </div>

<div id="menu">
    <div class="btn" data-shape="Saturn">Saturn</div>
    <div class="btn" data-shape="Sphere">Sphere</div>
    <div class="btn" data-shape="Heart">Heart</div>
    <div class="btn" data-shape="Flower">Flower</div>
    <div class="btn active" data-shape="Fireworks">Universe</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<!-- 2025년 현재 가장 안정적인 MediaPipe 링크들 (fallback 포함) -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>

<script>
    document.getElementById('loader').style.display = 'block';

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
    camera.position.z = 35;
    const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
    renderer.setSize(innerWidth, innerHeight); renderer.setPixelRatio(devicePixelRatio);
    document.body.appendChild(renderer.domElement);
    scene.add(new THREE.AmbientLight(0x404040));

    const COUNT = 3000;
    const geom = new THREE.BufferGeometry();
    const pos = new Float32Array(COUNT*3);
    const target = new Float32Array(COUNT*3);
    for(let i=0;i<COUNT*3;i++) pos[i]=(Math.random()-0.5)*50;
    geom.setAttribute('position', new THREE.BufferAttribute(pos,3));

    const canvas = document.createElement('canvas'); canvas.width=canvas.height=32;
    const ctx = canvas.getContext('2d');
    const grad = ctx.createRadialGradient(16,16,0,16,16,16);
    grad.addColorStop(0,'rgba(255,255,255,1)');
    grad.addColorStop(0.4,'rgba(255,255,255,0.4)');
    grad.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=grad; ctx.fillRect(0,0,32,32);
    const tex = new THREE.CanvasTexture(canvas);

    const mat = new THREE.PointsMaterial({
        size:0.6, map:tex, transparent:true, opacity:0.9,
        depthWrite:false, blending:THREE.AdditiveBlending, color:0xffffff
    });
    const particles = new THREE.Points(geom, mat); scene.add(particles);

    const shapes = {
        Saturn: () => { const a=[]; for(let i=0;i<COUNT;i++){ if(Math.random()>0.3){ const u=Math.random(),v=Math.random(); const theta=2*Math.PI*u,phi=Math.acos(2*v-1); a.push(6*Math.sin(phi)*Math.cos(theta),6*Math.sin(phi)*Math.sin(theta),6*Math.cos(phi)); } else { const ang=Math.random()*Math.PI*2,d=9+Math.random()*6; a.push(d*Math.cos(ang),(Math.random()-0.5)*0.8,d*Math.sin(ang)); }} return a; },
        Sphere: () => { const a=[]; for(let i=0;i<COUNT;i++){ const u=Math.random(),v=Math.random(); const theta=2*Math.PI*u,phi=Math.acos(2*v-1); const r=10; a.push(r*Math.sin(phi)*Math.cos(theta),r*Math.sin(phi)*Math.sin(theta),r*Math.cos(phi)); } return a; },
        Heart: () => { const a=[]; for(let i=0;i<COUNT;i++){ let t=Math.random()*Math.PI*2; const x=16*Math.pow(Math.sin(t),3); const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t); const z=(Math.random()-0.5)*5; a.push(x*0.5,y*0.5,z); } return a; },
        Flower: () => { const a=[]; for(let i=0;i<COUNT;i++){ const u=Math.random()*20*Math.PI; const r=5+5*Math.cos(4/3*u); a.push(r*Math.cos(u),r*Math.sin(u),(Math.random()-0.5)*5); } return a; },
        Fireworks: () => { const a=[]; for(let i=0;i<COUNT;i++){ a.push((Math.random()-0.5)*80,(Math.random()-0.5)*80,(Math.random()-0.5)*80); } return a; }
    };

    let currentShape = 'Fireworks';
    let wasDetected = false;

    function transition(name){
        const p = shapes[name]();
        for(let i=0;i<p.length;i++) target[i]=p[i];
        currentShape = name;
        document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));
        document.querySelector(`.btn[data-shape="${name}"]`).classList.add('active');
    }
    transition('Fireworks');

    document.querySelectorAll('.btn').forEach(btn => btn.onclick = () => transition(btn.dataset.shape));

    const video = document.createElement('video'); video.style.display='none'; document.body.appendChild(video);
    let dist=0, detected=false;

    const hands = new Hands({locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`});
    hands.setOptions({maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.7, minTrackingConfidence:0.7});
    hands.onResults(results => {
        document.getElementById('loader').style.display = 'none';
        detected = results.multiHandLandmarks && results.multiHandLandmarks.length===2;

        if(detected && !wasDetected){ transition('Saturn'); }
        if(!detected && wasDetected && currentShape !== 'Fireworks'){
            setTimeout(() => { if(!detected) transition('Fireworks'); }, 600);
        }
        wasDetected = detected;
        if(detected){
            const a=results.multiHandLandmarks[0][8], b=results.multiHandLandmarks[1][8];
            dist = Math.hypot(a.x-b.x, a.y-b.y);
        }
    });

    const cameraUtils = new Camera(video, {
        onFrame: async () => await hands.send({image: video}),
        width: 640, height: 480
    });
    cameraUtils.start();

    let scale=1, t=0;
    function animate(){
        requestAnimationFrame(animate); t+=0.01;
        const p = geom.attributes.position.array;
        for(let i=0;i<COUNT*3;i++) p[i]+=(target[i]-p[i])*0.05;
        geom.attributes.position.needsUpdate = true;

        const targetScale = detected ? Math.max(0.3, Math.min(4.5, (dist-0.1)*6)) : 1 + Math.sin(t)*0.1;
        scale += (targetScale-scale)*0.1;
        particles.scale.setScalar(scale);

        particles.rotation.y += 0.003;
        particles.rotation.x += 0.0008;
        mat.size = 0.6 + Math.sin(t*5)*0.08;
        renderer.render(scene,camera);
    }
    animate();

    window.addEventListener('resize',()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>